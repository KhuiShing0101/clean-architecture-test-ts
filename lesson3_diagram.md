# Lesson 3: Domain Services & Multi-Entity Operations - Architecture Flow Diagram

## Overview

**Lesson 3: Book Borrowing System**
- **Focus**: Domain Services for multi-entity coordination
- **Domain**: User Entity + Book Entity + BorrowBookService
- **Pattern**: Transaction boundaries across multiple aggregates
- **Use Case**: Borrow and return books with overdue fee calculation

---

## Complete Architecture Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          LESSON 3: DOMAIN SERVICES & MULTI-ENTITY OPERATIONS                â”‚
â”‚         Coordinating User + Book for Borrowing with Overdue Fees            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         PRESENTATION LAYER (Future)                       â•‘
â•‘                                                                           â•‘
â•‘  POST /api/books/borrow                                                   â•‘
â•‘  {                                                                        â•‘
â•‘    "userId": "12345678",    // 8-digit user ID                           â•‘
â•‘    "bookId": "a1b2c3d4-..."  // Book UUID                                â•‘
â•‘  }                                                                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                        â”‚
                                        â”‚ HTTP Request
                                        â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          APPLICATION LAYER                                â•‘
â•‘                   (Orchestration - Entity Retrieval)                      â•‘
â•‘                                                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â•‘
â•‘  â”‚  BorrowBookUseCase.execute(input)                                â”‚    â•‘
â•‘  â”‚                                                                   â”‚    â•‘
â•‘  â”‚  Step 1: Find User by ID (Application Concern)                   â”‚    â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚    â•‘
â•‘  â”‚  â”‚ const userId = UserId.create(input.userId)â”‚                   â”‚    â•‘
â•‘  â”‚  â”‚ const user = await userRepo.findById(userId)â”‚â”€â”€â”€â”            â”‚    â•‘
â•‘  â”‚  â”‚ if (!user) return error                   â”‚    â”‚            â”‚    â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚            â”‚    â•‘
â•‘  â”‚                                                   â”‚            â”‚    â•‘
â•‘  â”‚  Step 2: Find Book by ID (Application Concern)   â”‚            â”‚    â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚            â”‚    â•‘
â•‘  â”‚  â”‚ const book = await bookRepo.findById(     â”‚    â”‚            â”‚    â•‘
â•‘  â”‚  â”‚   input.bookId                            â”‚â”€â”€â”€â”€â”¼â”€â”€â”€â”        â”‚    â•‘
â•‘  â”‚  â”‚ )                                         â”‚    â”‚   â”‚        â”‚    â•‘
â•‘  â”‚  â”‚ if (!book) return error                   â”‚    â”‚   â”‚        â”‚    â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚        â”‚    â•‘
â•‘  â”‚                                                   â”‚   â”‚        â”‚    â•‘
â•‘  â”‚  Step 3: Delegate to Domain Service              â”‚   â”‚        â”‚    â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚        â”‚    â•‘
â•‘  â”‚  â”‚ const result = await                     â”‚    â”‚   â”‚        â”‚    â•‘
â•‘  â”‚  â”‚   borrowService.execute(user, book)      â”‚â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”    â”‚    â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚   â”‚    â”‚    â•‘
â•‘  â”‚                                                   â”‚   â”‚   â”‚    â”‚    â•‘
â•‘  â”‚  Step 4: Transform to DTO (Application Concern)  â”‚   â”‚   â”‚    â”‚    â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚   â”‚    â”‚    â•‘
â•‘  â”‚  â”‚ return { success, message, user, book }  â”‚    â”‚   â”‚   â”‚    â”‚    â•‘
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚   â”‚    â”‚    â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                        â”‚ â”‚   â”‚   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚   â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
                    â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚   â”‚   â”‚                     â”‚
                    â–¼   â–¼   â–¼                     â–¼
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                            DOMAIN LAYER                                   â•‘
â•‘           (Business Logic - Multi-Entity Coordination) â­                 â•‘
â•‘                                                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚  â­ DOMAIN SERVICE - BorrowBookService                           â”‚   â•‘
â•‘  â”‚  (THE STAR OF LESSON 3)                                          â”‚   â•‘
â•‘  â”‚                                                                   â”‚   â•‘
â•‘  â”‚  Why Domain Service?                                             â”‚   â•‘
â•‘  â”‚  â€¢ Logic spans multiple entities (User + Book)                   â”‚   â•‘
â•‘  â”‚  â€¢ Doesn't naturally belong to one entity                        â”‚   â•‘
â•‘  â”‚  â€¢ Significant domain concept (Borrowing)                        â”‚   â•‘
â•‘  â”‚  â€¢ Coordinates state changes across aggregates                   â”‚   â•‘
â•‘  â”‚                                                                   â”‚   â•‘
â•‘  â”‚  async execute(user: User, book: Book): Promise<Result> {        â”‚   â•‘
â•‘  â”‚                                                                   â”‚   â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â•‘
â•‘  â”‚    â”‚ Step 1: Validate User Eligibility (Domain Rule)         â”‚  â”‚   â•‘
â•‘  â”‚    â”‚   if (!user.canBorrow()) {                              â”‚  â”‚   â•‘
â•‘  â”‚    â”‚     // Check: suspended? at limit? has fees?            â”‚  â”‚   â•‘
â•‘  â”‚    â”‚     return { success: false, error: ... }               â”‚  â”‚   â•‘
â•‘  â”‚    â”‚   }                                                      â”‚  â”‚   â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â•‘
â•‘  â”‚                          â†“                                       â”‚   â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â•‘
â•‘  â”‚    â”‚ Step 2: Validate Book Availability (Domain Rule)        â”‚  â”‚   â•‘
â•‘  â”‚    â”‚   if (!book.isAvailable()) {                            â”‚  â”‚   â•‘
â•‘  â”‚    â”‚     return { success: false, error: ... }               â”‚  â”‚   â•‘
â•‘  â”‚    â”‚   }                                                      â”‚  â”‚   â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â•‘
â•‘  â”‚                          â†“                                       â”‚   â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â•‘
â•‘  â”‚    â”‚ Step 3: Update User State (IMMUTABLE)                   â”‚  â”‚   â•‘
â•‘  â”‚    â”‚   const updatedUser = user.borrowBook()                 â”‚  â”‚   â•‘
â•‘  â”‚    â”‚   // Returns NEW User with count + 1                    â”‚  â”‚   â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â•‘
â•‘  â”‚                          â†“                                       â”‚   â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â•‘
â•‘  â”‚    â”‚ Step 4: Update Book State (IMMUTABLE)                   â”‚  â”‚   â•‘
â•‘  â”‚    â”‚   const updatedBook = book.borrow(user.id)              â”‚  â”‚   â•‘
â•‘  â”‚    â”‚   // Returns NEW Book with borrower + timestamp         â”‚  â”‚   â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â•‘
â•‘  â”‚                          â†“                                       â”‚   â•‘
â•‘  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â•‘
â•‘  â”‚    â”‚ Step 5: Persist Both Changes (TRANSACTION BOUNDARY) â­  â”‚  â”‚   â•‘
â•‘  â”‚    â”‚   await userRepository.save(updatedUser)                â”‚  â”‚   â•‘
â•‘  â”‚    â”‚   await bookRepository.save(updatedBook)                â”‚  â”‚   â•‘
â•‘  â”‚    â”‚   // In production: wrap in DB transaction              â”‚  â”‚   â•‘
â•‘  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â•‘
â•‘  â”‚                          â†“                                       â”‚   â•‘
â•‘  â”‚    return { success: true, updatedUser, updatedBook }           â”‚   â•‘
â•‘  â”‚  }                                                               â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•‘                                                                         â”‚
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚  Entity: User           â”‚  Entity: Book                         â”‚   â•‘
â•‘  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â•‘
â•‘  â”‚  â”‚ User (from L2)    â”‚  â”‚  â”‚ Book (Enhanced for L3)          â”‚  â”‚   â•‘
â•‘  â”‚  â”‚                   â”‚  â”‚  â”‚                                 â”‚  â”‚   â•‘
â•‘  â”‚  â”‚ - id: UserId      â”‚  â”‚  â”‚ - id: string                   â”‚  â”‚   â•‘
â•‘  â”‚  â”‚ - name            â”‚  â”‚  â”‚ - isbn: ISBN                   â”‚  â”‚   â•‘
â•‘  â”‚  â”‚ - email           â”‚  â”‚  â”‚ - title                        â”‚  â”‚   â•‘
â•‘  â”‚  â”‚ - status          â”‚  â”‚  â”‚ - author                       â”‚  â”‚   â•‘
â•‘  â”‚  â”‚ - currentBorrow   â”‚  â”‚  â”‚ - status: BookStatus           â”‚  â”‚   â•‘
â•‘  â”‚  â”‚   Count           â”‚  â”‚  â”‚ - borrowedBy: UserId | null â—„â”€â”€â”¼â”€â”€â”¼â”€â”
â•‘  â”‚  â”‚ - overdueFees     â”‚  â”‚  â”‚ - borrowedAt: Date | null      â”‚  â”‚ â”‚
â•‘  â”‚  â”‚ - createdAt       â”‚  â”‚  â”‚ - createdAt                    â”‚  â”‚ â”‚
â•‘  â”‚  â”‚                   â”‚  â”‚  â”‚ - updatedAt                    â”‚  â”‚ â”‚
â•‘  â”‚  â”‚ Business Logic:   â”‚  â”‚  â”‚                                 â”‚  â”‚ â”‚
â•‘  â”‚  â”‚ â€¢ canBorrow()     â”‚  â”‚  â”‚ Business Constants:             â”‚  â”‚ â”‚
â•‘  â”‚  â”‚ â€¢ borrowBook()    â”‚  â”‚  â”‚ â€¢ BORROW_PERIOD_DAYS = 14       â”‚  â”‚ â”‚
â•‘  â”‚  â”‚ â€¢ returnBook()    â”‚  â”‚  â”‚                                 â”‚  â”‚ â”‚
â•‘  â”‚  â”‚ â€¢ addOverdueFee() â”‚  â”‚  â”‚ Business Logic:                 â”‚  â”‚ â”‚
â•‘  â”‚  â”‚ â€¢ payOverdueFee() â”‚  â”‚  â”‚ â€¢ isAvailable()                 â”‚  â”‚ â”‚
â•‘  â”‚  â”‚ â€¢ suspend()       â”‚  â”‚  â”‚ â€¢ borrow(userId): Book â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”¤
â•‘  â”‚  â”‚ â€¢ activate()      â”‚  â”‚  â”‚ â€¢ returnBook(): Book            â”‚  â”‚ â”‚
â•‘  â”‚  â”‚                   â”‚  â”‚  â”‚ â€¢ isOverdue(): boolean          â”‚  â”‚ â”‚
â•‘  â”‚  â”‚ MAX_BORROW_LIMIT  â”‚  â”‚  â”‚ â€¢ getOverdueDays(): number      â”‚  â”‚ â”‚
â•‘  â”‚  â”‚ = 5               â”‚  â”‚  â”‚ â€¢ reserve()                     â”‚  â”‚ â”‚
â•‘  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â€¢ cancelReservation()           â”‚  â”‚ â”‚
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â•‘                            â”‚                                       â”‚ â”‚
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â•‘  â”‚  Repository Interfaces                                        â”‚  â”‚ â”‚
â•‘  â”‚                                                               â”‚  â”‚ â”‚
â•‘  â”‚  IUserRepository             IBookRepository                  â”‚  â”‚ â”‚
â•‘  â”‚  - save(user)                - save(book)                     â”‚  â”‚ â”‚
â•‘  â”‚  - findById(id)              - findById(id) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”˜
â•‘  â”‚  - findByEmail(email)        - findByISBN(isbn)              â”‚  â”‚
â•‘  â”‚  - findUsersWithFees()       - findByStatus(status)          â”‚  â”‚
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                        â–²
                                        â”‚ implements
                                        â”‚
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                       INFRASTRUCTURE LAYER                                â•‘
â•‘                                                                           â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â•‘
â•‘  â”‚  PrismaUserRepository              MySQLBookRepository           â”‚   â•‘
â•‘  â”‚                                                                   â”‚   â•‘
â•‘  â”‚  - save(user)                      - save(book)                  â”‚   â•‘
â•‘  â”‚    UPDATE users                      UPDATE books                â”‚   â•‘
â•‘  â”‚    SET current_borrow_count = ..     SET status = 'BORROWED'    â”‚   â•‘
â•‘  â”‚    WHERE id = ...                    SET borrowed_by = ...       â”‚   â•‘
â•‘  â”‚                                      SET borrowed_at = NOW()     â”‚   â•‘
â•‘  â”‚                                      WHERE id = ...              â”‚   â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                        â”‚
                                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚       PostgreSQL Database              â”‚
                â”‚                                        â”‚
                â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                â”‚  â”‚ users table  â”‚ books table      â”‚  â”‚
                â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
                â”‚  â”‚ id           â”‚ id               â”‚  â”‚
                â”‚  â”‚ name         â”‚ isbn             â”‚  â”‚
                â”‚  â”‚ email        â”‚ title            â”‚  â”‚
                â”‚  â”‚ status       â”‚ author           â”‚  â”‚
                â”‚  â”‚ current_     â”‚ status           â”‚  â”‚
                â”‚  â”‚ borrow_count â”‚ borrowed_by â—„â”€â”€â”€â”€â”¼â”€â”€â”¼â”€ FK reference
                â”‚  â”‚ overdue_fees â”‚ borrowed_at      â”‚  â”‚
                â”‚  â”‚ created_at   â”‚ created_at       â”‚  â”‚
                â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                â”‚                                        â”‚
                â”‚  TRANSACTION BOUNDARY:                 â”‚
                â”‚  BEGIN;                                â”‚
                â”‚    UPDATE users SET ...;               â”‚
                â”‚    UPDATE books SET ...;               â”‚
                â”‚  COMMIT;                               â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Domain Service Pattern - The Core Concept

### When to Use Domain Services?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               DOMAIN SERVICE DECISION TREE                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Does the operation involve multiple entities?
    â”‚
    â”œâ”€ NO  â†’ Use entity method
    â”‚        Example: user.suspend()
    â”‚
    â””â”€ YES â†’ Continue â†“

Does the logic naturally belong to one entity?
    â”‚
    â”œâ”€ YES â†’ Use entity method
    â”‚        Example: user.borrowBook() (just updates user)
    â”‚
    â””â”€ NO  â†’ Continue â†“

Is this a significant domain concept?
    â”‚
    â”œâ”€ NO  â†’ Maybe just use case orchestration
    â”‚
    â””â”€ YES â†’ âœ… USE DOMAIN SERVICE
             Example: BorrowBookService
             - Coordinates User + Book
             - Enforces borrowing business rules
             - Manages transaction boundaries
```

---

## Multi-Entity State Coordination

### Borrowing Flow - State Changes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   BEFORE: Initial State                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User                      â”‚          â”‚ Book                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: "12345678"           â”‚          â”‚ id: "book-uuid-123"      â”‚
â”‚ name: "John Doe"         â”‚          â”‚ title: "Clean Code"      â”‚
â”‚ email: "john@..."        â”‚          â”‚ author: "Robert Martin"  â”‚
â”‚ status: ACTIVE           â”‚          â”‚ status: AVAILABLE        â”‚
â”‚ currentBorrowCount: 2    â”‚          â”‚ borrowedBy: null         â”‚
â”‚ overdueFees: 0           â”‚          â”‚ borrowedAt: null         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â†“
        BorrowBookService.execute(user, book)
                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DOMAIN SERVICE COORDINATION (Step by Step)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: Validate User
   user.canBorrow() â†’ âœ“ true
   - status === ACTIVE âœ“
   - currentBorrowCount (2) < 5 âœ“
   - overdueFees === 0 âœ“

Step 2: Validate Book
   book.isAvailable() â†’ âœ“ true
   - status === AVAILABLE âœ“

Step 3: Update User (Immutable)
   const updatedUser = user.borrowBook()

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Original User            â”‚
   â”‚ currentBorrowCount: 2    â”‚  â”€â”
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                  â”‚ Returns NEW instance
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚ Updated User             â”‚ â—„â”€â”˜
   â”‚ currentBorrowCount: 3    â”‚  â† CHANGED
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 4: Update Book (Immutable)
   const updatedBook = book.borrow(user.id)

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Original Book            â”‚
   â”‚ status: AVAILABLE        â”‚  â”€â”
   â”‚ borrowedBy: null         â”‚   â”‚
   â”‚ borrowedAt: null         â”‚   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                  â”‚ Returns NEW instance
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚ Updated Book             â”‚ â—„â”€â”˜
   â”‚ status: BORROWED         â”‚  â† CHANGED
   â”‚ borrowedBy: "12345678"   â”‚  â† CHANGED
   â”‚ borrowedAt: 2025-11-11   â”‚  â† CHANGED
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 5: Persist (Transaction Boundary)
   await userRepository.save(updatedUser)  // â† First save
   await bookRepository.save(updatedBook)  // â† Second save
   // In production: wrap both in DB transaction

                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AFTER: Final State in Database                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User                      â”‚          â”‚ Book                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: "12345678"           â”‚          â”‚ id: "book-uuid-123"      â”‚
â”‚ name: "John Doe"         â”‚          â”‚ title: "Clean Code"      â”‚
â”‚ email: "john@..."        â”‚          â”‚ author: "Robert Martin"  â”‚
â”‚ status: ACTIVE           â”‚          â”‚ status: BORROWED âœ“       â”‚
â”‚ currentBorrowCount: 3 âœ“  â”‚          â”‚ borrowedBy: "12345678" âœ“ â”‚
â”‚ overdueFees: 0           â”‚          â”‚ borrowedAt: 2025-11-11 âœ“ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       UPDATED!                               UPDATED!
```

---

## Return with Overdue Fee Calculation

### Scenario: Book is 20 Days Overdue

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              RETURN OPERATION WITH OVERDUE FEES                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User (Before Return)     â”‚          â”‚ Book (20 days borrowed)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: "12345678"           â”‚          â”‚ id: "book-uuid-123"      â”‚
â”‚ currentBorrowCount: 3    â”‚          â”‚ status: BORROWED         â”‚
â”‚ overdueFees: 0           â”‚          â”‚ borrowedBy: "12345678"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ borrowedAt: 20 days ago  â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        BorrowBookService.returnBook(user, book)
                    â†“

Step 1: Validate Ownership
   book.borrowedBy.equals(user.id) â†’ âœ“ true

Step 2: Check if Overdue
   book.isOverdue() â†’ âœ“ true
   - borrowedAt: 20 days ago
   - BORROW_PERIOD_DAYS: 14
   - 20 > 14 â†’ OVERDUE!

Step 3: Calculate Overdue Fee
   overdueDays = book.getOverdueDays()
   - (now - borrowedAt) / (1000 * 60 * 60 * 24) = 20 days
   - 20 - 14 = 6 days overdue

   overdueFee = 6 days * Â¥100/day = Â¥600

Step 4: Update User (with fee)
   let updatedUser = user.returnBook()
   // currentBorrowCount: 3 â†’ 2

   updatedUser = updatedUser.addOverdueFee(600)
   // overdueFees: 0 â†’ 600

Step 5: Update Book
   const updatedBook = book.returnBook()
   // status: BORROWED â†’ AVAILABLE
   // borrowedBy: "12345678" â†’ null
   // borrowedAt: date â†’ null

Step 6: Persist Both
   await userRepository.save(updatedUser)
   await bookRepository.save(updatedBook)

                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User (After Return)      â”‚          â”‚ Book (After Return)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id: "12345678"           â”‚          â”‚ id: "book-uuid-123"      â”‚
â”‚ currentBorrowCount: 2 âœ“  â”‚          â”‚ status: AVAILABLE âœ“      â”‚
â”‚ overdueFees: 600 âœ“       â”‚          â”‚ borrowedBy: null âœ“       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ borrowedAt: null âœ“       â”‚
   UPDATED WITH FEE!                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          RETURNED!
```

---

## Transaction Boundaries

### Why Transaction Boundaries Matter

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 TRANSACTION BOUNDARY IMPORTANCE                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ WITHOUT TRANSACTION:
   await userRepository.save(updatedUser)  // âœ“ Success
   await bookRepository.save(updatedBook)  // âœ— FAILS!

   Result: User has borrowed book but book status is still AVAILABLE
   â†’ INCONSISTENT STATE! ğŸ’¥

âœ… WITH TRANSACTION:
   BEGIN TRANSACTION;
   await userRepository.save(updatedUser)  // âœ“ Success
   await bookRepository.save(updatedBook)  // âœ— FAILS!
   ROLLBACK;  // â† Both changes reverted

   Result: Both user and book remain unchanged
   â†’ CONSISTENT STATE! âœ…

Production Implementation:
   const transaction = await prisma.$transaction([
     prisma.user.update({ where: { id: user.id }, data: { ... } }),
     prisma.book.update({ where: { id: book.id }, data: { ... } })
   ]);

   All-or-nothing: Both succeed or both fail
```

---

## Domain Service vs Application Service

### Clear Separation of Concerns

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            DOMAIN SERVICE vs APPLICATION SERVICE                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BorrowBookUseCase           â”‚ BorrowBookService                      â”‚
â”‚ (Application Layer)          â”‚ (Domain Layer) â­                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             â”‚                                        â”‚
â”‚ Responsibilities:            â”‚ Responsibilities:                      â”‚
â”‚ â€¢ Find entities by ID       â”‚ â€¢ Validate business rules              â”‚
â”‚ â€¢ Validate entities exist   â”‚ â€¢ Coordinate entity state changes      â”‚
â”‚ â€¢ Delegate to domain       â”‚ â€¢ Enforce domain invariants            â”‚
â”‚ â€¢ Transform to DTOs        â”‚ â€¢ Manage transaction boundaries        â”‚
â”‚ â€¢ Handle application errors â”‚ â€¢ Apply complex business logic         â”‚
â”‚                             â”‚                                        â”‚
â”‚ Example:                     â”‚ Example:                               â”‚
â”‚ const user = await          â”‚ if (!user.canBorrow()) {               â”‚
â”‚   userRepo.findById(id)     â”‚   return { success: false, error: ... }â”‚
â”‚ if (!user) {                â”‚ }                                      â”‚
â”‚   return error              â”‚ if (!book.isAvailable()) {             â”‚
â”‚ }                           â”‚   return { success: false, error: ... }â”‚
â”‚ return await borrowService  â”‚ }                                      â”‚
â”‚   .execute(user, book)      â”‚ const updatedUser = user.borrowBook()  â”‚
â”‚                             â”‚ const updatedBook = book.borrow(userId)â”‚
â”‚                             â”‚ await userRepo.save(updatedUser)       â”‚
â”‚                             â”‚ await bookRepo.save(updatedBook)       â”‚
â”‚                             â”‚                                        â”‚
â”‚ Returns: DTOs               â”‚ Returns: Domain objects                â”‚
â”‚ Depends on: Domain services â”‚ Depends on: Domain interfaces          â”‚
â”‚ Lives in: Application layer â”‚ Lives in: Domain layer                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Business Rules Enforcement

### Complex Multi-Entity Validation

```typescript
// Domain Service enforces business rules across entities
async execute(user: User, book: Book): Promise<BorrowBookResult> {
  // Rule 1: User eligibility (from User entity)
  if (!user.canBorrow()) {
    // Sub-rules:
    // - User must not be SUSPENDED
    // - User must be under MAX_BORROW_LIMIT (5)
    // - User must have no overdue fees
    return { success: false, error: '...' };
  }

  // Rule 2: Book availability (from Book entity)
  if (!book.isAvailable()) {
    // Sub-rules:
    // - Book status must be AVAILABLE
    return { success: false, error: '...' };
  }

  // Rule 3: State coordination (Domain Service responsibility)
  // - Both entities must be updated atomically
  // - Transaction boundary enforced
  // - Immutability maintained

  // ...
}
```

---

## Time-Based Business Rules

### Overdue Calculation Logic

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              14-DAY BORROW PERIOD WITH FEES                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Timeline:
Day 0:  Book borrowed (borrowedAt = 2025-11-01)
Day 7:  No problem
Day 14: Last day before overdue
Day 15: OVERDUE! Fee starts accumulating
Day 20: Return book â†’ 6 days overdue

Calculation:
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Days Borrowed   â”‚ Status       â”‚ Fee
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ 0-14 days       â”‚ On time      â”‚ Â¥0
â”‚ 15 days         â”‚ 1 day overdueâ”‚ Â¥100
â”‚ 16 days         â”‚ 2 days overdueâ”‚ Â¥200
â”‚ 20 days         â”‚ 6 days overdueâ”‚ Â¥600  â† Example
â”‚ 30 days         â”‚ 16 days overdueâ”‚ Â¥1,600
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Formula:
  overdueDays = Math.floor(daysBorrowed - BORROW_PERIOD_DAYS)
  overdueFee = overdueDays * FEE_PER_DAY (Â¥100)

Code:
  isOverdue(): boolean {
    const daysDiff = (now - borrowedAt) / (1000 * 60 * 60 * 24);
    return daysDiff > Book.BORROW_PERIOD_DAYS;  // 14
  }

  getOverdueDays(): number {
    const daysDiff = (now - borrowedAt) / (1000 * 60 * 60 * 24);
    return Math.floor(daysDiff - Book.BORROW_PERIOD_DAYS);
  }
```

---

## Complete Request Flow Example

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. API REQUEST                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POST /api/books/borrow
{
  "userId": "12345678",
  "bookId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
}

                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. APPLICATION LAYER - BorrowBookUseCase                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// Step 1: Find User
const userId = UserId.create("12345678")
const user = await userRepository.findById(userId)
if (!user) return error("User not found")

Result: User {
  id: UserId("12345678"),
  name: "John Doe",
  currentBorrowCount: 2,
  status: ACTIVE,
  overdueFees: 0
}

// Step 2: Find Book
const book = await bookRepository.findById("a1b2c3d4-...")
if (!book) return error("Book not found")

Result: Book {
  id: "a1b2c3d4-...",
  title: "Clean Architecture",
  author: "Robert Martin",
  status: AVAILABLE,
  borrowedBy: null,
  borrowedAt: null
}

// Step 3: Delegate to Domain Service
const result = await borrowService.execute(user, book)

                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. DOMAIN LAYER - BorrowBookService                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// Domain Validation 1: User eligibility
user.canBorrow()
  â”œâ”€ status === ACTIVE? âœ“
  â”œâ”€ currentBorrowCount (2) < 5? âœ“
  â””â”€ overdueFees === 0? âœ“
Result: true âœ“

// Domain Validation 2: Book availability
book.isAvailable()
  â””â”€ status === AVAILABLE? âœ“
Result: true âœ“

// Domain Operation 1: Update User (immutable)
const updatedUser = user.borrowBook()
  â†’ NEW User { currentBorrowCount: 3 }

// Domain Operation 2: Update Book (immutable)
const updatedBook = book.borrow(userId)
  â†’ NEW Book {
      status: BORROWED,
      borrowedBy: UserId("12345678"),
      borrowedAt: 2025-11-11T10:30:00Z
    }

// Persist Changes (transaction boundary)
await userRepository.save(updatedUser)
  â†’ UPDATE users SET current_borrow_count = 3 WHERE id = '12345678'

await bookRepository.save(updatedBook)
  â†’ UPDATE books SET
      status = 'BORROWED',
      borrowed_by = '12345678',
      borrowed_at = '2025-11-11 10:30:00'
    WHERE id = 'a1b2c3d4-...'

return { success: true, updatedUser, updatedBook }

                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. APPLICATION LAYER - Transform to DTO                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

return {
  success: true,
  message: "Book borrowed successfully",
  user: {
    userId: "12345678",
    name: "John Doe",
    currentBorrowCount: 3,
    overdueFees: 0
  },
  book: {
    bookId: "a1b2c3d4-...",
    title: "Clean Architecture",
    author: "Robert Martin",
    status: "BORROWED",
    borrowedBy: "12345678",
    borrowedAt: "2025-11-11T10:30:00Z"
  }
}

                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. API RESPONSE                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HTTP 200 OK
{
  "success": true,
  "message": "Book borrowed successfully",
  "user": { ... },
  "book": { ... }
}
```

---

## Key Takeaways

### âœ… What Lesson 3 Teaches:

1. **Domain Services**: Stateless services for multi-entity coordination
2. **Transaction Boundaries**: Atomic updates across multiple aggregates
3. **Time-Based Rules**: Business logic based on temporal calculations
4. **Multi-Entity Validation**: Complex rules spanning multiple entities
5. **Immutability at Scale**: Maintaining immutability across entity graph
6. **Clear Separation**: Domain logic vs application orchestration

### ğŸ“Š Complexity Level: â­â­â­â­â­ (Advanced)

- Multi-entity coordination
- Domain services introduction
- Transaction management
- Time-based business rules
- Complex validation logic
- Overdue fee calculations

### ğŸ¯ Comparison with Previous Lessons:

| Aspect | Lesson 1 | Lesson 2 | **Lesson 3** |
|--------|---------|----------|-------------|
| **Entities** | 1 (Book) | 1 (User) | **2 (User + Book)** |
| **Domain Services** | âŒ | âŒ | **âœ… BorrowBookService** |
| **Multi-Entity** | âŒ | âŒ | **âœ… Yes** |
| **Transaction** | Single | Single | **Multiple (atomic)** |
| **Time-Based Rules** | âŒ | âŒ | **âœ… Overdue calc** |
| **Complexity** | Basic | Medium | **High** |

### ğŸš€ Advanced Patterns:

- âœ… Domain Services (multi-entity coordination)
- âœ… Transaction boundaries (all-or-nothing)
- âœ… Time-based business rules (14-day period)
- âœ… Overdue fee calculation (Â¥100/day)
- âœ… Complex validation (user + book eligibility)
- âœ… Immutability across entities

---

**Expected Score Range**: 95-100
**Pass Criteria**: Score â‰¥ 60 with no ERROR violations
**Key Focus**: Domain services, multi-entity coordination, transaction boundaries
