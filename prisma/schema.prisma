generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

// ========== Lesson 1: Book Management System (Enhanced for Lesson 3) ==========

model Book {
  id         String     @id
  isbn       String     @unique
  title      String
  author     String
  status     BookStatus @default(AVAILABLE)
  borrowedBy String?    @map("borrowed_by")
  borrowedAt DateTime?  @map("borrowed_at")
  created_at DateTime   @default(now()) @map("createdAt")
  updated_at DateTime   @updatedAt @map("updatedAt")

  @@index([isbn])
  @@index([status])
  @@index([borrowedBy])
  @@map("books")
}

enum BookStatus {
  AVAILABLE
  BORROWED
  RESERVED
}

// ========== Lesson 2: User Management System ==========

model User {
  id                 String     @id
  name               String
  email              String     @unique
  status             UserStatus @default(ACTIVE)
  currentBorrowCount Int        @default(0) @map("current_borrow_count")
  overdueFees        Float      @default(0) @map("overdue_fees")
  createdAt          DateTime   @default(now()) @map("created_at")

  @@index([email])
  @@index([status])
  @@map("users")
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

// ========== Lesson 4: Order Management System (Aggregates) ==========

model Order {
  id           String      @id
  customerId   String      @map("customer_id")
  totalAmount  Float       @map("total_amount")
  currency     String      @default("JPY")
  status       OrderStatus @default(DRAFT)
  createdAt    DateTime    @default(now()) @map("created_at")
  placedAt     DateTime?   @map("placed_at")
  completedAt  DateTime?   @map("completed_at")
  cancelledAt  DateTime?   @map("cancelled_at")

  // One-to-many relationship with OrderItems
  items OrderItem[]

  @@index([customerId])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

model OrderItem {
  id            String   @id @default(uuid())
  orderId       String   @map("order_id")
  bookId        String   @map("book_id")
  quantity      Int
  unitPrice     Float    @map("unit_price")
  currency      String   @default("JPY")
  subtotalAmount Float   @map("subtotal_amount")

  // Foreign key relationship to Order
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([bookId])
  @@map("order_items")
}

enum OrderStatus {
  DRAFT
  PLACED
  COMPLETED
  CANCELLED
}
